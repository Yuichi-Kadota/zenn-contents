---
title: "Terraformå…¥é–€"
emoji: "ğŸˆ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["terraform","IaC"]
published: false
---

# Terraformå…¥é–€

Terraformã®ã‚ªãƒ³ãƒœãƒ¼ãƒ‰ç›®çš„ã«ä½œæˆã—ãŸè¨˜äº‹ã§ã™ã€‚

# IaC(Infrastructure as Code)

Terraformã«å…¥é–€ã™ã‚‹å‰ã«ã€IaCã®å®šç¾©ã‚„è€ƒãˆæ–¹ã«ã¤ã„ã¦ãŠã•ã‚‰ã„ã—ã¾ã—ã‚‡ã†ã€‚

## ãã‚‚ãã‚‚IaCã¨ã¯

IaCã¨ã¯**ã‚¤ãƒ³ãƒ•ãƒ©ãƒªã‚½ãƒ¼ã‚¹ã®ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã‚’ã‚ªãƒ¼ãƒˆãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³**ã—ã€ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢é–‹ç™ºã®ã‚ˆã†ã«è¡Œã†ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ã™ã€‚

æ—§æ¥ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã§ã®ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰ã¯ã€ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã®å°å…¥/æ•·è¨­å·¥äº‹/çµç·šä½œæ¥­ãªã©æ©Ÿæ¢°ã«ä»»ã›ã‚‹äº‹ãŒé›£ã—ã„ä½œæ¥­ã‚‚å¤šã„ã‚‚ã®ã§ã—ãŸã€‚

ã—ã‹ã—ã€ä»®æƒ³åŒ–æŠ€è¡“ã®ç™ºé”ã‚„è¿‘å¹´ã®ã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã®æµ¸é€ã«ä¼´ã„ã€IaCãƒ„ãƒ¼ãƒ«ã«ã‚ˆã‚‹ã‚ªãƒ¼ãƒˆãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰ã¨åˆ‡ã£ã¦ã‚‚åˆ‡ã‚Šé›¢ã›ãªã„ã‚‚ã®ã¨ãªã‚Šã¾ã—ãŸã€‚

å¤šãã®IaCãƒ„ãƒ¼ãƒ«ã¯å…±é€šã—ã¦ä»¥ä¸‹ã®æ©Ÿèƒ½ã‚’æŒã£ã¦ã„ã¾ã™ã€‚

- å¯¾è±¡ã¨ãªã‚‹ã‚¤ãƒ³ãƒ•ãƒ©ãƒªã‚½ãƒ¼ã‚¹ã‚’ç‰¹å®šã®è¨€èªã§å®šç¾©ã™ã‚‹
- è¨˜è¿°ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‹ã‚‰ãƒ„ãƒ¼ãƒ«ã‚’ä»‹ã—ã¦ã‚¤ãƒ³ãƒ•ãƒ©ãƒªã‚½ãƒ¼ã‚¹ã®æ“ä½œã‚’è¡Œã†

ã“ã†ã—ãŸæ©Ÿèƒ½ã‚’æŒã¤ãƒ„ãƒ¼ãƒ«ã‚’é€šã˜ã¦ã€ã‚¤ãƒ³ãƒ•ãƒ©ã‚’ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦ç®¡ç†ã™ã‚‹(ã‚ªãƒ¼ãƒˆãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³)ã®ãŒIaCã§ã™ã€‚

## ä»£è¡¨çš„ãªãƒ„ãƒ¼ãƒ«ç¾¤

IaCã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã¯æ•°å¤šãã‚ã‚Šã¾ã™ãŒã€ä»£è¡¨çš„ãªã‚‚ã®ã‚’ä¸Šã’ã¦ãŠãã¾ã™ã€‚

é‡è¦ãªã®ã¯ã€ã€Œå„IaCãƒ„ãƒ¼ãƒ«ã®å¯¾è±¡ç¯„å›²ã€ã‚’æŠŠæ¡ã—ç”¨é€”ã«å¿œã˜ãŸã‚‚ã®ã‚’é¸å®šã™ã‚‹äº‹ã§ã™ã€‚

![iac.drawio.png](Terraform%E5%85%A5%E9%96%80%20ffacba80fcfa412dbc3060a1dea3b822/iac.drawio.png)

## ãƒ¡ãƒªãƒƒãƒˆ

- ã‚¤ãƒ³ãƒ•ãƒ©ãƒªã‚½ãƒ¼ã‚¹ã®è¨­å®šãŒã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ä¸Šã§ä¸€è¦§ã¨ã—ã¦ç¢ºèªã§ãã‚‹
- ã‚¤ãƒ³ãƒ•ãƒ©å¤‰æ›´ã‚’Gitã®å±¥æ­´ã‹ã‚‰è¿½ã†ã“ã¨ãŒã§ãã‚‹
- CI/CDã«ã‚ˆã‚‹é™çš„æ¤œæŸ»ã‚„ã€å®‰å…¨ãªè‡ªå‹•é©ç”¨ãªã©ãŒã§ãã‚‹
- ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®å†åˆ©ç”¨ã«ã‚ˆã‚Šã€ç’°å¢ƒè¤‡è£½ãªã©ãŒæ­£ç¢ºã‹ã¤ç´ æ—©ãè¡Œã†ã“ã¨ãŒã§ãã‚‹

## ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ

- å°è¦æ¨¡ã‚µãƒ¼ãƒ“ã‚¹ã§ã‚ã‚Œã°æ‰‹ä½œæˆã—ã¦ã—ã¾ã£ãŸæ–¹ãŒæ—©ã„
- é‹ç”¨è¨­è¨ˆã‚’è¡Œã‚ãªã„ã¨ã€ç®¡ç†ç¯„å›²ãŒå¢—ãˆã¦ã—ã¾ã„ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚³ã‚¹ãƒˆã‚‚å¢—ãˆã‚‹

# Terraformã¨ã¯

---

[Terraform](https://www.terraform.io/)ã¯ã€HashiCorpç¤¾ãŒæä¾›ã™ã‚‹IaCãƒ„ãƒ¼ãƒ«ã§ã™ã€‚

ï¼ˆTerraformè‡ªä½“ã¯Goã§å®Ÿè£…ã•ã‚ŒãŸOSSãƒ„ãƒ¼ãƒ«ã¨ãªã£ã¦ã„ã¾ã™ï¼‰

æœ¬é …ã§ã¯ãã®åŸºæœ¬çš„ãªæ©Ÿèƒ½ãªä»•çµ„ã¿ã«ã¤ã„ã¦ã”ç´¹ä»‹ã—ã¾ã™ã€‚

## è¨€èª

HCL(HashiCorp Language)ã¨ã„ã†Jsonãƒ©ã‚¤ã‚¯ãªç‹¬è‡ªã®DSLã‚’é€šã˜ã¦ã€ã‚¤ãƒ³ãƒ•ãƒ©ãƒªã‚½ãƒ¼ã‚¹ã®ç®¡ç†ã‚’è¡Œã†äº‹ãŒã§ãã¾ã™ã€‚

*HCLã§ã®è¨˜è¿°ä¾‹*

```json
resource "aws_s3_bucket" "bucket" {
  bucket = "${local.bucket_name}-bucket"
  tags = {
    "Service" = "SaleSpot"
  }
}
```

## å¯¾è±¡

providerï¼ˆ[è©³ç´°ã¯å¾Œè¿°ã—ã¾ã™](https://www.notion.so/Terraform-3e0e48890f5b4790bf6c3542742e95ed)ï¼‰ã¨ã„ã†æ©Ÿèƒ½ã«ã‚ˆã‚ŠæŠ½è±¡åŒ–ã—ã¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ‰±ã†ãŸã‚ã€æ•°å¤šãã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚„ãƒ„ãƒ¼ãƒ«ã‚’å¯¾è±¡ã¨ã™ã‚‹äº‹ãŒã§ãã¾ã™ã€‚

*å¯¾å¿œãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ä¾‹*

- ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ 
    - AWS
    - GCP
    - Azure
- ç›£è¦–ç³»SaaSãƒ„ãƒ¼ãƒ«
    - Datadog
    - New Relic
- ãã®ä»–
    - Cloudflare
    - heroku
    - vercel

è¤‡æ•°ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’çµ„ã¿åˆã‚ã›ã¦ç’°å¢ƒæ§‹ç¯‰ã‚’è¡Œã†ã‚ˆã†ãªå ´åˆã«ã€å…¨ã¦ã‚’åŒã˜ä»•çµ„ã¿ã§ç®¡ç†ã§ãã‚‹ã¨ã„ã†ã®ãŒTerraformã®å¤§ããªãƒ¡ãƒªãƒƒãƒˆã®ä¸€ã¤ã§ã™ã€‚

## åŸºæœ¬â‘ .providerã¨tfstate

å…·ä½“çš„ãªterraformã®ä»•çµ„ã¿ã‚’ç†è§£ã™ã‚‹ãŸã‚ã«ã€`Provider`ã¨`tfstate`ã®å½¹å‰²ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚

ä¸‹è¨˜å›³ã®é€šã‚Šã€terraformã‚’å®Ÿè¡Œã™ã‚‹éš›ã«ã¯ã€å®Ÿéš›ã®ç’°å¢ƒã¸ã®ãƒªã‚½ãƒ¼ã‚¹ä½œæˆã¨tfstateã¸ã®æ›¸ãè¾¼ã¿ãŒè¡Œã‚ã‚Œã¾ã™ã€‚

![provider.drawio (2).png](Terraform%E5%85%A5%E9%96%80%20ffacba80fcfa412dbc3060a1dea3b822/provider.drawio_(2).png)

### Provider

- å®Ÿè¡Œå…ˆã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«åˆã‚ã›ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’çµ±åˆç®¡ç†ã™ã‚‹å½¹å‰²ã‚’æŒã¡ã¾ã™ã€‚ï¼ˆAWSã§ã‚ã‚Œã°ã€AWSç”¨ã®Providerã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦åˆ©ç”¨ã—ã¾ã™ã€‚ï¼‰
- å„ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®APIãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿â‡„HCLã®æ©‹æ¸¡ã—ã‚’ã™ã‚‹å½¹å‰²ã§ã™ã€‚
    - HCLã§æŒ‡å®šã•ã‚Œã¦ã„ãªã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã‚ã£ã¦ã‚‚ã€å®Ÿè¡Œæ™‚ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®šã™ã‚‹
    - å®Ÿè¡Œå‰ã«APIãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†

### tfstate

- terraformã‚’å®Ÿè¡Œã—ãŸãƒªã‚½ãƒ¼ã‚¹ã®æƒ…å ±ãŒè©°ã¾ã£ãŸJsonãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚
- å®Ÿè¡Œæ™‚ã«Terraform+Providerã‚’é€šã—ã¦è¨˜éŒ²ã•ã‚Œã¾ã™ã€‚
- å®Ÿè¡Œè¨ˆç”»ã®å–å¾—æ™‚ãªã©ã‚‚å‚ç…§ã•ã‚Œã¾ã™ï¼ˆâ€»å¾Œè¿°ã—ã¾ã™ï¼‰

## åŸºæœ¬â‘¡.å®Ÿè¡Œã‚µã‚¤ã‚¯ãƒ«ï¼ˆinit/plan/applyï¼‰

æ¬¡ã«terraformã®å®Ÿè¡Œã‚µã‚¤ã‚¯ãƒ«ã«ã¤ã„ã¦ç†è§£ã—ã¾ã—ã‚‡ã†ã€‚

terraformã‹ã‚‰ãƒªã‚½ãƒ¼ã‚¹ã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã«ã¯ã€ä»¥ä¸‹ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒã‚ã‚Šã¾ã™ã€‚

![lifecycle.drawio.png](Terraform%E5%85%A5%E9%96%80%20ffacba80fcfa412dbc3060a1dea3b822/lifecycle.drawio.png)

### 1.init

`terraform init`ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œã—ã¾ã™

- Providerã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
- HCLã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
- Data Resource/Remote Stateãªã©å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿

### 2.plan

`terraform plan`ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œã—ã¾ã™

- **tfstateã¨ã€HCLã®å·®åˆ†æ¯”è¼ƒ**
    - å·®åˆ†ãŒã‚ã‚‹å ´åˆã€å®Ÿè¡Œè¨ˆç”»ã®å‡ºåŠ›
- Providerãƒ™ãƒ¼ã‚¹ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯

*plançµæœä¾‹*

```json
Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # aws_s3_bucket.bucket will be created
  + resource "aws_s3_bucket" "bucket" {
      + acceleration_status         = (known after apply)
      + acl                         = (known after apply)
      + arn                         = (known after apply)
      + bucket                      = "salespot-bucket"
      + bucket_domain_name          = (known after apply)
      + bucket_regional_domain_name = (known after apply)
      + force_destroy               = false
      + hosted_zone_id              = (known after apply)
      + id                          = (known after apply)
      + object_lock_enabled         = (known after apply)
      + policy                      = (known after apply)
      + region                      = (known after apply)
      + request_payer               = (known after apply)
      + tags                        = {
          + "Service" = "SaleSpot"
        }
      + tags_all                    = {
          + "CreatedBy" = "terraform"
          + "Env"       = "staging"
          + "Service"   = "SaleSpot"
        }
      + website_domain              = (known after apply)
      + website_endpoint            = (known after apply)

      + cors_rule {
          + allowed_headers = (known after apply)
          + allowed_methods = (known after apply)
          + allowed_origins = (known after apply)
          + expose_headers  = (known after apply)
          + max_age_seconds = (known after apply)
        }

      + grant {
          + id          = (known after apply)
          + permissions = (known after apply)
          + type        = (known after apply)
          + uri         = (known after apply)
        }

      + lifecycle_rule {
          + abort_incomplete_multipart_upload_days = (known after apply)
          + enabled                                = (known after apply)
          + id                                     = (known after apply)
          + prefix                                 = (known after apply)
          + tags                                   = (known after apply)

          + expiration {
              + date                         = (known after apply)
              + days                         = (known after apply)
              + expired_object_delete_marker = (known after apply)
            }

          + noncurrent_version_expiration {
              + days = (known after apply)
            }

          + noncurrent_version_transition {
              + days          = (known after apply)
              + storage_class = (known after apply)
            }

          + transition {
              + date          = (known after apply)
              + days          = (known after apply)
              + storage_class = (known after apply)
            }
        }

      + logging {
          + target_bucket = (known after apply)
          + target_prefix = (known after apply)
        }

      + object_lock_configuration {
          + object_lock_enabled = (known after apply)

          + rule {
              + default_retention {
                  + days  = (known after apply)
                  + mode  = (known after apply)
                  + years = (known after apply)
                }
            }
        }

      + replication_configuration {
          + role = (known after apply)

          + rules {
              + delete_marker_replication_status = (known after apply)
              + id                               = (known after apply)
              + prefix                           = (known after apply)
              + priority                         = (known after apply)
              + status                           = (known after apply)

              + destination {
                  + account_id         = (known after apply)
                  + bucket             = (known after apply)
                  + replica_kms_key_id = (known after apply)
                  + storage_class      = (known after apply)

                  + access_control_translation {
                      + owner = (known after apply)
                    }

                  + metrics {
                      + minutes = (known after apply)
                      + status  = (known after apply)
                    }

                  + replication_time {
                      + minutes = (known after apply)
                      + status  = (known after apply)
                    }
                }

              + filter {
                  + prefix = (known after apply)
                  + tags   = (known after apply)
                }

              + source_selection_criteria {
                  + sse_kms_encrypted_objects {
                      + enabled = (known after apply)
                    }
                }
            }
        }

      + server_side_encryption_configuration {
          + rule {
              + bucket_key_enabled = (known after apply)

              + apply_server_side_encryption_by_default {
                  + kms_master_key_id = (known after apply)
                  + sse_algorithm     = (known after apply)
                }
            }
        }

      + versioning {
          + enabled    = (known after apply)
          + mfa_delete = (known after apply)
        }

      + website {
          + error_document           = (known after apply)
          + index_document           = (known after apply)
          + redirect_all_requests_to = (known after apply)
          + routing_rules            = (known after apply)
        }
    }

Plan: 1 to add, 0 to change, 0 to destroy.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

å®Ÿè¡Œè¨ˆç”»ã¯ã€`add`,`change`,`destroy`ã®3ã¤ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«åˆ†é¡ã•ã‚Œã¾ã™ã€‚

HCLãŒæ›¸ã‘ãŸã‚‰å®Ÿéš›ã«ä½œæˆã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹ã‚„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒæ„å›³ã—ãŸã‚‚ã®ã¨åŒã˜ã‹ã©ã†ã‹ç¢ºèªã™ã‚‹ãŸã‚ã«ã€å¿…ãšå®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†

## 3.apply

`terraform apply`ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œã—ã¾ã™

[å…ˆã»ã©ã¿ãŸå›³](https://www.notion.so/Terraform-3e0e48890f5b4790bf6c3542742e95ed)ã®é€šã‚Šã§ã™ãŒã€ä»¥ä¸‹ãŒå®Ÿè¡Œã•ã‚Œã¾ã™

- tfstateã¸ã®æ›¸ãè¾¼ã¿
- providerã‚’é€šã˜ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ä½œæˆã€å¤‰æ›´ï¼ˆAPIã®ç™ºè¡Œï¼‰

ãƒªã‚½ãƒ¼ã‚¹åã®é‡è¤‡ãªã©ã€å®Ÿéš›ã«APIã‚’ç™ºè¡Œã—ãªã„ã¨ã‚ã‹ã‚‰ãªã„ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ã«é–¢ã—ã¦ã¯ã€applyæ™‚ã«ã‚¨ãƒ©ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨ã—ã¦è¿”å´ã•ã‚Œã‚‹äº‹ãŒã‚ã‚Šã¾ã™ã€‚

## åŸºæœ¬â‘¢.ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã¨å®Ÿè¡Œå˜ä½

terraformã®å®Ÿè¡Œå˜ä½ã‚„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã«ã¤ã„ã¦ç†è§£ã—ã¾ã—ã‚‡ã†ã€‚

ãƒ‡ãƒ•ã‚¡ã‚¯ãƒˆã¨ãªã‚‹æ§‹æˆã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ä»Šå›ã¯[test-infra](https://github.com/brainbuddy/brain_buddy_infra)ãƒªãƒã‚¸ãƒˆãƒªã®è¨­è¨ˆã‚’ä¾‹ã«ã—ã¾ã™ã€‚

### æ§‹æˆä¾‹

```json
â””â”€â”€ network
    â””â”€â”€ stg                     ... ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
        â”œâ”€â”€ backend.tf          ... tfstateã®å®šç¾©ã€providerã®å®šç¾©
        â”œâ”€â”€ vpc.tf

       ~~~

    â””â”€â”€ prod  

			 ~~~
```

```json
<backend.tf>

provider "aws" {
  region = "ap-northeast-1"
  default_tags {
    tags = {
      CreatedBy = "terraform"
      Env       = "staging"
    }
  }
}

terraform {
  backend "s3" {
    bucket = "test-tfstate-staging"
    key    = "network/terraform.tfstate"
    region = "ap-northeast-1"
  }
}
```

```json
<vpc.tf>

resource "aws_vpc" "vpc" {
  cidr_block           = "10.1.0.0/16"
  enable_dns_support   = true
  enable_dns_hostnames = true
  tags = {
    Name = "${local.service}_${local.env}_vpc"
  }
}
```

- backend.tf
    - `provider`ãƒ–ãƒ­ãƒƒã‚¯ã§ã€å¯¾è±¡ã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãŒ`aws`ã§ã‚ã‚‹äº‹ã‚’å®£è¨€ã—ã¾ã™ã€‚
    - `terraform backnend`ãƒ–ãƒ­ãƒƒã‚¯ã§ã€**tfstateã®ä¿å­˜å…ˆã‚’å®£è¨€ã—ã¾ã™ã€‚**
        - ä»Šå›ã¯AWSä¸Šã®`test-tfstate-staging`ã¨ã„ã†s3ãƒã‚±ãƒƒãƒˆã«tfstateã‚’ä¿å­˜ã—ã¦ã„ã¾ã™ã€‚
        - ãƒã‚±ãƒƒãƒˆå†…ã®object keyã‚’`key`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§å®£è¨€ã—ã¾ã™
        - ãƒã‚±ãƒƒãƒˆã®regionã‚’`region`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§å®£è¨€ã—ã¾ã™
- vpc.tf
    - `resoure`ãƒ–ãƒ­ãƒƒã‚¯ã§å®šç¾©ã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã‚’å®£è¨€ã—ã¾ã™ã€‚
        - ä½•ã‚’å®šç¾©ã—ãŸã‚‰ã‚ã‹ã‚‰ãªã„å ´åˆã¯[å…¬å¼Doc](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/vpc)ã‚’å‚ç…§ã—ã¾ã—ã‚‡ã†
    - `resource`å†…ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ã€å„ãƒªã‚½ãƒ¼ã‚¹ã«å¯¾å¿œã—ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨˜è¿°ã—ã¾ã™ã€‚
        - `local.~`ã¨è¨˜è¿°ã•ã‚Œã¦ã„ã‚‹ç®‡æ‰€ã¯ã€å¤‰æ•°å‚ç…§ã—ã¦ã„ã‚‹ç®‡æ‰€ã§ã™ã€‚ï¼ˆä¸€æ—¦èª­ã¿é£›ã°ã—ã¦ã‚‚ã‚‰ã£ã¦okã§ã™ï¼‰

### å®Ÿè¡Œæ–¹æ³•

`terraform`ãƒ–ãƒ­ãƒƒã‚¯ãŒå®£è¨€ã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒã€å®Ÿè¡Œæ™‚ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨ãªã‚Šã¾ã™ã€‚

ï¼ˆç”¨èªã¨ã—ã¦ã¯ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨å‘¼ã³ã¾ã™ãŒã€ã‚ã¾ã‚ŠçŸ¥ã‚‰ã‚Œã¦ãªã„ã®ã§å¿˜ã‚Œã¦ã‚‚okã§ã™ï¼‰

ã¤ã¾ã‚Šã€**ä»Šå›ã®æ§‹æˆã§ã‚ã‚Œã°ã€`./staging`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå®Ÿè¡Œãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã™ã€‚**

ã¾ãŸã€**å®Ÿè¡Œæ™‚ã®å˜ä½=tfstateã®å˜ä½**ã¨ãªã‚Šã¾ã™ã€‚

ã“ã®ä¾‹ã ã¨ã€`./staging` ã¨ `./production`ã¯åˆ¥ã®tfstateã¨ã—ã¦ç®¡ç†ã•ã‚Œã¾ã™ã€‚

# ã¾ã¨ã‚

---

terraformã®åŸºæœ¬çš„ãªä»•çµ„ã¿ã‚’è§£èª¬ã—ã¾ã—ãŸã€‚

ç‰¹ã«provider,tfstateãªã©ã®æ©Ÿèƒ½ã¯ã‚ã‚‹ç¨‹åº¦ç†è§£ã—ã¦ã„ãªã„ã¨æ€ã‚ã¬äº‹æ•…ã«ç¹‹ãŒã‚‹ãŸã‚ã€ã‚ˆãç†è§£ã‚’æ·±ã‚ã‚‹äº‹ãŒå¤§åˆ‡ã§ã™ã€‚

ã¾ãŸå®Ÿéš›ã«é–‹ç™ºã‚’è¡Œã†ä¸Šã§ã¯terraformã®çŸ¥è­˜ã ã‘ã§ã¯ãªãå¯¾è±¡ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®çŸ¥è­˜ï¼ˆAWSã€GCPâ€¦etcï¼‰ã‚‚ä¸å¯æ¬ ã§ã™ã€‚

æœ€å¾Œã«ã€terraform(Ã—AWS)ã§å‚è€ƒã«ãªã‚‹æ›¸ç±ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

****[å®Ÿè·µTerraformã€€AWSã«ãŠã‘ã‚‹ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹](https://nextpublishing.jp/book/10983.html)****

ã¾ãŸã€terraformã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç­‰ã€ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ–¹æ³•ã«ã¤ã„ã¦ã¯[test-infraã®README](https://github.com/brainbuddy/brain_buddy_infra#readme)ã«è¨˜è¼‰ã—ã¦ã„ã‚‹ã®ã§ãã¡ã‚‰ã‚’ã”å‚ç…§ãã ã•ã„ã€‚